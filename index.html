<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Life Map</title>

<link rel="manifest" href="manifest.json">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin: 0; }
#map { height: 100vh; }

button {
    position: absolute;
    z-index: 1000;
    top: 10px;
    left: 10px;
    padding: 10px 15px;
    cursor: pointer;
}
</style>
</head>
<body>

<button onclick="startTracking()">–£–≤—ñ–º–∫–Ω—É—Ç–∏ GPS</button>
<div id="map"></div>

<script>
const map = L.map('map').setView([50, 30], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// üî• –î—É–∂–µ –º–∞–ª–µ–Ω—å–∫—ñ –ø–ª–∏—Ç–∫–∏ (~50-80–º)
const tileSize = 0.0005;

let visitedTiles = JSON.parse(localStorage.getItem("visitedTiles")) || [];
let visitedSet = new Set(visitedTiles);

visitedSet.forEach(key => {
    const [lat, lon] = key.split(",").map(Number);
    drawTile(lat, lon);
});

function startTracking() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(showPosition, null, {
            enableHighAccuracy: true
        });
    } else {
        alert("GPS –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è");
    }
}

function showPosition(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    map.setView([lat, lon], 17);

    const tileLat = Math.floor(lat / tileSize) * tileSize;
    const tileLon = Math.floor(lon / tileSize) * tileSize;

    const key = tileLat + "," + tileLon;

    if (!visitedSet.has(key)) {
        visitedSet.add(key);
        visitedTiles.push(key);
        localStorage.setItem("visitedTiles", JSON.stringify(visitedTiles));
        drawTile(tileLat, tileLon);
    }
}

function drawTile(lat, lon) {
    L.rectangle([
        [lat, lon],
        [lat + tileSize, lon + tileSize]
    ], {
        color: "#00ff88",
        fillColor: "#00ff88",
        fillOpacity: 0.5,
        weight: 0
    }).addTo(map);
}

// üî• –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>